# Portrait API Debug Log — 2026-02-27

## The Problem
The live site on Netlify (faithfulfriendportraits.co.za) is broken:
- Gallery shows no images
- OG rich text preview shows `undefined` in the image URL: `https://faithfulfriendportraits.co.za/portraits/undefined`

Both issues trace back to the `/api/portraits` endpoint returning a 500 error on Netlify.

## Root Cause
`server/api/portraits.get.ts` originally used Node.js `readdir` to list files in `public/portraits` at runtime. This works in local dev but fails on Netlify because serverless functions don't have filesystem access to the project's `public/` directory at runtime.

## What We Tried

### Attempt 1 — Nitro `serverAssets` with `getKeys()`
**What we did:**
- Added `nitro.serverAssets` in `nuxt.config.ts` pointing to `./public/portraits`
- Changed API to use `useStorage('assets:portraits').getKeys()` instead of `readdir`

**Result:** Broke dev (returned empty array). `getKeys()` appears to not work in dev mode for serverAssets. Had to add a `readdir` fallback for dev.

**After adding fallback:** Dev worked, but production still returned 500. `useStorage('assets:portraits').getKeys()` returned empty in the Netlify production environment too.

### Attempt 2 — Build hook + `server-data/` + `getItem()`
**What we did:**
- Added a `build:before` hook in `nuxt.config.ts` that reads `public/portraits` at build time and generates `server-data/portraits.json`
- Changed `serverAssets` to point to `./server-data`
- Changed API to use `useStorage('assets:server-data').getItem('portraits.json')`
- Added `server-data/` to `.gitignore`
- Kept `readdir` fallback for dev

**Result:** Dev still works. Production still broken (not yet confirmed why — possibly serverAssets still not bundling correctly on Netlify, or the build hook not running as expected).

## Current State of Files

### `nuxt.config.ts`
- Has `hooks['build:before']` that generates `server-data/portraits.json`
- Has `nitro.serverAssets` pointing to `./server-data`

### `server/api/portraits.get.ts`
- Tries `useStorage('assets:server-data').getItem('portraits.json')` first
- Falls back to `readdir('public/portraits')` for dev

### `pages/index.vue`
- OG image uses a random portrait: `portraitFiles.value?.[Math.floor(Math.random() * ...)]`
- If `portraitFiles` is null/empty, `ogImage` becomes `...portraits/undefined`

## Key Questions for Next Session
1. Does Nitro `serverAssets` actually work on Netlify at all? The `getKeys()` returned empty even after deployment.
2. Does the `build:before` hook actually run during Netlify's build step?
3. Is there a Netlify-specific Nitro preset needed? (`nitro.preset: 'netlify'`)
4. Could the solution be simpler — e.g. a `prebuild` npm script that generates a static JSON, bypassing Nitro storage entirely?
5. Check Netlify build logs to confirm whether the hook ran and generated the file.

## Alternative Approaches Not Yet Tried
- `prebuild` npm script to generate a static `public/portraits-list.json`, served as a plain static file fetched directly by the composable (no API route needed)
- Hardcode the portrait list in a JS/TS config file (simple but requires manual update per new portrait)
- `nitro.preset: 'netlify'` to ensure correct Netlify-specific build output
